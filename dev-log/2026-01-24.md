# Dev log 2026-01-24

## Progress
- Verified the Saga crawler output via `kikidoko-crawl --source saga --dry-run` to confirm the existing table parser still collects manufacturer/model/location links correctly.
- Tightened table header handling so RIKEN’s list now maps the "機器・施設名"/"分類"/"管轄先" columns instead of falling back to the generic `category_hint`/empty addresses.
- Added whitespace-stripping inside `normalize_label` and taught the location keywords to recognize "管轄" headers, then reran `kikidoko-crawl --source riken --dry-run` to ensure the new labels capture real category names and location strings.
- Updated `scrape-status/2026-01-18-scraping-status.md` to mark RIKEN as completed.
- Added a Shimane University scraper for `https://www.shimane-u.org/kiki.htm`, parsing the shared equipment tables (including rowspan categories) and preserving model + location data.
- Added a Shinshu University scraper for `https://www.shinshu-u.ac.jp/institution/kiban/kiki/secchi/`, extracting equipment names, models, categories, and locations from the equipment detail tables.
- Marked Shimane/Shinshu as completed and removed Saitama from the "未完了" list after confirming the public equipment list is not accessible.
- Added a Tokyo Tech crawler for the shared equipment search table, capturing names, categories, location/affiliation, external-use hints, and contact links.
- Added a TUAT crawler for the instrument facility site, collecting instrument pages from the index and extracting names, locations, contact details, and fee notes.
- Verified the TMDU table list still scrapes correctly and marked Tokyo Tech/TMDU/TUAT as completed.
- Added a Tottori University crawler using the public “共同利用設備” WP API, extracting categories, locations, and manufacturer/model details from each detail page.
- Added a Toyohashi University of Technology crawler for the analysis/engineering shared equipment lists, capturing equipment names and locations where available.
- Marked Tottori/Toyohashi as completed and moved Toyama to the excluded list because no public HTML equipment list is available (policy PDFs only).
- Added a Tsukuba University crawler that iterates the public search results, follows detail pages, and captures department/category/location + fee data.
- Added a UEC crawler using the public WP API (category: 設備紹介) to extract maker/model, manager, and location data.
- Marked Tsukuba/UEC as completed and moved Ryukyus to excluded because the public site returns HTTP 403.
- Added a Utsunomiya University crawler for the accordion-based equipment list, capturing section/group categories plus maker/model, location, and contact details.
- Added a Yamaguchi University crawler for the RFMC facility list cards, extracting category, department, campus, and usage metadata from the HTML list.
- Added a Yamanashi University crawler for the equipment list table (with a browser UA to bypass 403 blocks), mapping maker/model and category fields.
- Added a Yokohama National University crawler that follows machine list detail pages and uses the page title as a fallback when "機器名" is absent.
- Updated Firestore upsert flow to prefetch org indexes, throttle writes, and fall back to deterministic doc IDs when quota blocks reads.
- Updated the crawler README and scrape-status list for the newly completed sources.
- Added a Kagawa University crawler for the nanoplatform equipment tables, capturing section categories and details.
- Added a Kochi University crawler for the Instruments lists, skipping the non-inventory "重要" section.
- Added a Tokushima University crawler for the machine-data JSON feed and stripped HTML tags from the JSON fields.
- Added a University of the Ryukyus crawler using the UR-CORE list/detail pages to collect department, category, and fee/external-use data.
- Updated the scraping status list to mark Kagawa/Kochi/Tokushima/University of the Ryukyus as completed and remove Ryukyus from exclusions.

## Notes
- RIKEN’s table uses spaced headers (e.g., "分　類"), so the extra whitespace removal is what allowed `_map_headers` to resolve the correct columns.
- The RIKEN detail column still mixes center names with action links; the parser now stores that text in `address_raw`, so `prefecture`/`org_type` can still be deduced from the common org name.
- Saitama’s public center site links to an internal equipment list that returns HTTP 403, so it remains excluded per the "公開ページに機器一覧が見当たらない" rule.
- Ryukyus’ equipment portal (rfc.lab.u-ryukyu.ac.jp) responds with HTTP 403 from public networks, so it is excluded per the login/restriction policy.
- Yamanashi’s list page returns HTTP 403 without a browser UA, so the crawler forces a standard UA header to access the HTML list.
- The Firestore index build hit read quotas during the YNU write, so the run proceeded without read checks (doc IDs derived from equipment_id/dedupe_key).
- Kagawa/Kochi use SHA-1 fallbacks for equipment IDs when the names are non-ASCII to avoid collisions.
- Kochi’s Instruments page includes a separate “重要” summary list; it is skipped to avoid duplicating the main inventory.
- Tokushima’s JSON endpoint presents an invalid TLS certificate, so the crawler disables verification and removes HTML tags from notes.
- Ryukyus’ rfc.lab.u-ryukyu.ac.jp portal still returns HTTP 403; UR-CORE is used instead.

## Validation
- Saga dry run: 103 records, with manufacturer/model/contact + detail URLs preserved.
- RIKEN dry run: 26 records now include the actual category text (not just the fallback) and carry the location column as `address_raw`.
- Shimane dry run: 36 records from the shared equipment tables.
- Shinshu dry run: 8 records from the Matsumoto equipment list page.
- Tokyo Tech dry run: 791 records from the shared equipment search table.
- TMDU dry run: 67 records from the shared equipment list page.
- TUAT dry run: 13 records from the instrument facility site.
- Tottori dry run: 212 records from the joint-use equipment catalog.
- Toyohashi dry run: 47 records from the shared equipment lists.
- Tsukuba dry run: 239 records from the openfacility list/detail pages.
- UEC dry run: 34 records from the equipment introduction posts.
- Utsunomiya dry run: 71 records from the shared equipment accordions.
- Yamaguchi dry run: 199 records from the RFMC equipment list cards.
- Yamanashi dry run: 67 records from the equipment list table.
- YNU dry run: 67 records from the machine list detail pages.
- Utsunomiya write: created=71 updated=0.
- Yamaguchi write: created=135 updated=64.
- Yamanashi write: created=67 updated=0.
- YNU write: created=67 updated=0 (index build skipped due to quota).
- Kagawa dry run: 24 records.
- Kochi dry run: 25 records.
- Tokushima dry run: 55 records.
- Ryukyu dry run: 176 records.
- Kagawa write: created=24 updated=0.
- Kochi write: created=25 updated=0.
- Tokushima write: created=51 updated=4.
- Ryukyu write: created=176 updated=0.

## Next steps
- All institutions in the "未完了" list are now completed; monitor Firestore quotas and rerun YNU with read checks if duplicate cleanup is required.
