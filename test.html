<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kikidoko â€“ ç ”ç©¶æ©Ÿå™¨ã‚’åœ°åŸŸã‹ã‚‰æ¢ã™</title>
  <style>
    :root{
      /* Colors - warm neutral */
      --bg: #FBF6EE;
      --surface: #FFF9F1;
      --surface-2: #FFF1DE;
      --border: #E8DDCF;

      /* Text */
      --text: #2A231B;
      --text-2: #5B4E42;
      --text-3: #8A7B6D;

      /* Primary (only one strong accent) */
      --primary: #C57A2A;
      --primary-2: #A96320;

      /* States */
      --ok: #2E7D5B;
      --warn: #B8791B;
      --unknown: #7A7A7A;

      /* Shadows */
      --shadow-sm: 0 2px 8px rgba(42,35,27,.08);
      --shadow-md: 0 6px 18px rgba(42,35,27,.10);

      /* Radius */
      --r-lg: 16px;
      --r-md: 12px;
      --r-sm: 10px;

      /* Spacing */
      --s-1: 4px;
      --s-2: 8px;
      --s-3: 12px;
      --s-4: 16px;
      --s-5: 24px;
      --s-6: 32px;

      /* Type */
      --fs-1: 12px;
      --fs-2: 14px;
      --fs-3: 16px;
      --fs-4: 20px;
      --fs-5: 30px;

      --lh: 1.55;

      /* Layout */
      --max: 1220px;

      /* Focus */
      --focus: 0 0 0 3px color-mix(in srgb, var(--primary) 25%, transparent);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font: 400 var(--fs-3)/var(--lh) system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    a{ color:inherit; }
    .container{
      max-width: var(--max);
      margin: 0 auto;
      padding: 0 var(--s-5);
    }

    /* Header */
    header.top{
      padding: var(--s-6) 0 var(--s-4);
    }
    .top__inner{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: var(--s-5);
    }
    .brand{
      font-size: var(--fs-5);
      font-weight: 800;
      letter-spacing: .2px;
    }
    .tagline{
      margin-top: var(--s-1);
      color: var(--text-2);
      font-size: var(--fs-2);
    }
    .meta{
      color: var(--text-3);
      font-size: var(--fs-1);
      white-space: nowrap;
      padding-top: 6px;
    }

    /* Searchbar (sticky) */
    section.searchbar{
      position: sticky;
      top: 0;
      z-index: 20;
      padding: var(--s-3) 0;
      background: color-mix(in srgb, var(--bg) 86%, white);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .searchbar__box{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: var(--s-4);
      box-shadow: var(--shadow-sm);
    }
    .row{
      display:flex;
      gap: var(--s-3);
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .row + .row{ margin-top: var(--s-3); }
    .row--meta{
      align-items:center;
      justify-content:space-between;
      gap: var(--s-3);
    }

    .field{
      min-width: 160px;
    }
    .field.grow{
      flex: 1 1 320px;
      min-width: 240px;
    }
    .field label{
      display:block;
      font-size: var(--fs-1);
      color: var(--text-3);
      margin-bottom: var(--s-1);
    }

    select, input[type="text"]{
      height: 42px;
      width: 100%;
      border-radius: var(--r-md);
      border: 1px solid var(--border);
      background: white;
      padding: 0 var(--s-3);
      color: var(--text);
      outline: none;
      box-shadow: none;
    }
    select:focus, input[type="text"]:focus{
      border-color: color-mix(in srgb, var(--primary) 45%, var(--border));
      box-shadow: var(--focus);
    }

    .control{
      display:flex;
      gap: var(--s-2);
      align-items:center;
    }
    .iconbtn{
      height: 42px;
      width: 42px;
      border-radius: var(--r-md);
      border: 1px solid var(--border);
      background: var(--surface-2);
      cursor:pointer;
    }
    .iconbtn:focus{ outline:none; box-shadow: var(--focus); }
    .iconbtn[aria-pressed="true"]{
      background: color-mix(in srgb, var(--primary) 18%, var(--surface-2));
      border-color: color-mix(in srgb, var(--primary) 35%, var(--border));
    }

    .btn{
      height: 42px;
      padding: 0 var(--s-4);
      border-radius: var(--r-md);
      border: 1px solid transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: var(--s-2);
      text-decoration:none;
      cursor:pointer;
      font-weight:700;
      user-select: none;
      white-space: nowrap;
    }
    .btn:focus{ outline:none; box-shadow: var(--focus); }
    .btn--primary{
      background: var(--primary);
      color: white;
    }
    .btn--primary:hover{ background: var(--primary-2); }
    .btn--ghost{
      background: transparent;
      color: var(--text);
      border-color: var(--border);
    }
    .btn--ghost:hover{ background: var(--surface-2); }

    .linkbtn{
      background: transparent;
      border: 0;
      color: var(--text-2);
      cursor:pointer;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
    }
    .linkbtn:hover{ background: color-mix(in srgb, var(--surface-2) 60%, white); }
    .linkbtn:focus{ outline:none; box-shadow: var(--focus); }
    .linkbtn.muted{ color: var(--text-3); font-weight: 650; }

    .chips{
      display:flex;
      gap: var(--s-2);
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      border: 1px solid var(--border);
      background: white;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: var(--fs-2);
      color: var(--text-2);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .chip:hover{ background: var(--surface-2); }
    .chip:focus{ outline:none; box-shadow: var(--focus); }
    .chip .x{
      display:inline-flex;
      width: 18px;
      height: 18px;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text-3);
      font-weight: 900;
      line-height: 1;
    }

    .advanced{
      margin-top: var(--s-3);
      padding-top: var(--s-3);
      border-top: 1px dashed var(--border);
      display:grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap: var(--s-2) var(--s-4);
    }
    @media (max-width: 900px){
      .advanced{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
    }
    @media (max-width: 520px){
      .advanced{ grid-template-columns: 1fr; }
    }
    .check{
      display:flex;
      gap: 10px;
      align-items:center;
      font-size: var(--fs-2);
      color: var(--text-2);
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--r-md);
      padding: 10px 12px;
    }
    .check input{ transform: translateY(1px); }

    /* Layout */
    main.layout{
      padding: var(--s-5) 0 var(--s-6);
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap: var(--s-5);
      align-items:start;
    }
    @media (max-width: 1023px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* Results bar */
    .resultsbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: var(--s-3);
      margin-bottom: var(--s-3);
      flex-wrap:wrap;
    }
    .resultsbar__title{
      font-weight: 900;
      letter-spacing: .2px;
    }
    .resultsbar__sub{
      color: var(--text-3);
      font-size: var(--fs-2);
      margin-left: 8px;
      font-weight: 650;
    }
    .sort{
      display:flex;
      align-items:center;
      gap: var(--s-2);
      color: var(--text-2);
      font-size: var(--fs-2);
    }
    .sort select{
      height: 38px;
      padding: 0 12px;
      border-radius: 999px;
    }

    /* Cards */
    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: var(--s-4);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--s-3);
    }
    .card__head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: var(--s-3);
    }
    .card__title{
      font-size: var(--fs-4);
      font-weight: 900;
      letter-spacing: .1px;
    }
    .card__sub{
      margin-top: var(--s-1);
      color: var(--text-2);
      font-size: var(--fs-2);
    }
    .badge{
      font-size: var(--fs-2);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-weight: 900;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .badge--ok{ border-color: color-mix(in srgb, var(--ok) 45%, var(--border)); color: var(--ok); }
    .badge--warn{ border-color: color-mix(in srgb, var(--warn) 45%, var(--border)); color: var(--warn); }
    .badge--unknown{ border-color: color-mix(in srgb, var(--unknown) 45%, var(--border)); color: var(--unknown); }

    .card__meta{
      margin-top: var(--s-3);
      display:flex;
      justify-content:space-between;
      gap: var(--s-3);
      flex-wrap:wrap;
      color: var(--text-2);
      font-size: var(--fs-2);
    }
    .muted{ color: var(--text-3); }

    .flags{
      margin-top: var(--s-3);
      display:flex;
      gap: var(--s-2);
      flex-wrap:wrap;
    }
    .flag{
      font-size: var(--fs-2);
      color: var(--text-2);
      background: white;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      display:inline-flex;
      align-items:center;
      gap: 6px;
    }

    .card__cta{
      margin-top: var(--s-4);
      display:flex;
      gap: var(--s-2);
      flex-wrap:wrap;
    }
    .btn--small{
      height: 40px;
      padding: 0 var(--s-4);
    }

    /* Right panel */
    .panel{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow-sm);
      overflow:hidden;
      position: sticky;
      top: 110px; /* below sticky searchbar */
    }
    @media (max-width: 1023px){
      .panel{ position: static; }
    }
    .tabs{
      display:flex;
      border-bottom: 1px solid var(--border);
      background: color-mix(in srgb, white 55%, var(--surface));
    }
    .tab{
      flex: 1;
      height: 46px;
      border: 0;
      background: transparent;
      cursor: pointer;
      font-weight: 900;
      color: var(--text-2);
    }
    .tab:hover{ background: color-mix(in srgb, var(--surface-2) 55%, white); }
    .tab:focus{ outline:none; box-shadow: var(--focus); }
    .tab.is-active{
      background: var(--surface-2);
      color: var(--text);
    }
    .panel__body{ padding: var(--s-4); }

    .empty{
      background: white;
      border: 1px dashed var(--border);
      border-radius: var(--r-md);
      padding: var(--s-5);
      text-align:center;
    }
    .empty__title{ font-weight: 900; }
    .empty__text{ margin-top: var(--s-2); color: var(--text-2); font-size: var(--fs-2); }

    .listblock{
      margin-top: var(--s-3);
      display:flex;
      flex-direction:column;
      gap: var(--s-2);
    }
    .itemrow{
      display:flex;
      justify-content:space-between;
      gap: var(--s-2);
      align-items:center;
      padding: 10px 12px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--r-md);
    }
    .itemrow button{
      border: 0;
      background: transparent;
      font-weight: 900;
      color: var(--text);
      cursor:pointer;
      padding: 0;
      text-align:left;
    }
    .itemrow button:hover{ text-decoration: underline; }
    .count{
      color: var(--text-2);
      font-size: var(--fs-2);
      white-space: nowrap;
    }

    .notice{
      margin-top: var(--s-3);
      font-size: var(--fs-2);
      color: var(--text-3);
      line-height: 1.6;
    }

    /* Footer */
    footer{
      padding: 0 0 var(--s-6);
      color: var(--text-3);
      font-size: var(--fs-2);
    }

    /* Small helper */
    .sr-only{
      position:absolute;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
  </style>
</head>

<body>
  <header class="top">
    <div class="container">
      <div class="top__inner">
        <div>
          <div class="brand">Kikidoko</div>
          <div class="tagline">ç ”ç©¶æ©Ÿå™¨ã‚’åœ°åŸŸã‹ã‚‰æ¢ã™</div>
        </div>
        <div class="meta" id="lastUpdated">æœ€çµ‚æ›´æ–° 2026.01.25</div>
      </div>
    </div>
  </header>

  <section class="searchbar" aria-label="æ¤œç´¢">
    <div class="container">
      <div class="searchbar__box">
        <div class="row" role="search">
          <div class="field">
            <label for="region">åœ°åŸŸ</label>
            <div class="control">
              <select id="region" aria-label="åœ°åŸŸï¼ˆéƒ½é“åºœçœŒï¼‰">
                <option value="">éƒ½é“åºœçœŒï¼ˆã™ã¹ã¦ï¼‰</option>
              </select>
              <button id="geoBtn" class="iconbtn" type="button" aria-label="ç¾åœ¨åœ°ã‚’ä½¿ã†" aria-pressed="false" title="ç¾åœ¨åœ°ã‚’ä½¿ã†">ğŸ“</button>
            </div>
          </div>

          <div class="field">
            <label for="category">ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="category" aria-label="ã‚«ãƒ†ã‚´ãƒª">
              <option value="">ã™ã¹ã¦</option>
            </select>
          </div>

          <div class="field grow">
            <label for="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</label>
            <input id="keyword" type="text" inputmode="search" placeholder="ä¾‹ï¼‰XRD, TEM, ICP" aria-label="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰" />
          </div>

          <button id="searchBtn" class="btn btn--primary" type="button">æ¤œç´¢</button>
        </div>

        <div class="row row--meta">
          <div class="chips" id="chips" aria-label="é©ç”¨ä¸­ã®æ¡ä»¶"></div>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button id="toggleAdvanced" class="linkbtn" type="button" aria-expanded="false">è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ â–¼</button>
            <button id="resetBtn" class="linkbtn muted" type="button">æ¡ä»¶ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>

        <div id="advanced" class="advanced" hidden>
          <label class="check"><input id="fExternal" type="checkbox"> å­¦å¤–åˆ©ç”¨å¯ã®ã¿</label>
          <label class="check"><input id="fFree" type="checkbox"> ç„¡æ–™è¨­å‚™ã®ã¿</label>
          <label class="check"><input id="fReservable" type="checkbox"> äºˆç´„å¯ã®ã¿</label>
          <label class="check"><input id="fSupport" type="checkbox"> æ¸¬å®šæ”¯æ´ã‚ã‚Šã®ã¿</label>
        </div>
      </div>
    </div>
  </section>

  <main class="layout">
    <div class="container">
      <div class="grid">
        <!-- Left: results -->
        <section aria-label="æ¤œç´¢çµæœ">
          <div class="resultsbar">
            <div>
              <span class="resultsbar__title" id="resultsTitle">æ¤œç´¢çµæœ</span>
              <span class="resultsbar__sub" id="resultsSub"></span>
            </div>

            <div class="sort">
              <label for="sortSel">ä¸¦ã³æ›¿ãˆ</label>
              <select id="sortSel" aria-label="ä¸¦ã³æ›¿ãˆ">
                <option value="relevance">ãŠã™ã™ã‚</option>
                <option value="distance">è·é›¢ï¼ˆç¾åœ¨åœ°ï¼‰</option>
                <option value="updated">æ›´æ–°æ—¥</option>
                <option value="availability">åˆ©ç”¨å¯å¦</option>
                <option value="freeFirst">ç„¡æ–™å„ªå…ˆ</option>
              </select>
            </div>
          </div>

          <div id="cards"></div>

          <div class="notice" id="hint">
            ãƒ‡ãƒ¼ã‚¿ã¯å…¬çš„æ©Ÿé–¢ãŒå…¬é–‹ã™ã‚‹æƒ…å ±ã‚’ã‚‚ã¨ã«åé›†ãƒ»æ›´æ–°ã—ã¾ã™ã€‚åˆ©ç”¨ç™»éŒ²ã‚„æ‰‹ç¶šãã¯å„ã‚µãƒ¼ãƒ“ã‚¹å´ã§å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚
          </div>
        </section>

        <!-- Right: panel -->
        <aside aria-label="åˆ†å¸ƒã¨é›†è¨ˆ">
          <div class="panel">
            <div class="tabs" role="tablist" aria-label="å³ãƒ‘ãƒãƒ«åˆ‡æ›¿">
              <button class="tab is-active" id="tabMap" role="tab" aria-selected="true" aria-controls="panelContent" data-tab="map" type="button">åœ°å›³</button>
              <button class="tab" id="tabPref" role="tab" aria-selected="false" aria-controls="panelContent" data-tab="pref" type="button">çœŒåˆ¥</button>
              <button class="tab" id="tabOrg" role="tab" aria-selected="false" aria-controls="panelContent" data-tab="org" type="button">æ©Ÿé–¢åˆ¥</button>
            </div>

            <div class="panel__body" id="panelContent"></div>
          </div>
        </aside>
      </div>

      <footer>
        <div class="notice">
          â€»ã“ã®HTMLã¯UI/UXæ”¹å–„æ¡ˆã®ã€Œå‹•ããƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã€ã§ã™ã€‚å®Ÿãƒ‡ãƒ¼ã‚¿æ¥ç¶šãƒ»åœ°å›³è¡¨ç¤ºã¯æœ¬ç•ªå´ã§ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
        </div>
      </footer>
    </div>
  </main>

<script>
/**
 * Kikidoko prototype (single-file)
 * - åœ°åŸŸãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®æ¤œç´¢
 * - é©ç”¨æ¡ä»¶ãƒãƒƒãƒ—è¡¨ç¤º
 * - çµæœã‚«ãƒ¼ãƒ‰åŒ–
 * - å³ãƒ‘ãƒãƒ«ï¼šåœ°å›³ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰/çœŒåˆ¥/æ©Ÿé–¢åˆ¥
 * - ç¾åœ¨åœ°ï¼ˆè¨±å¯æ™‚ï¼‰ï¼šè·é›¢è¨ˆç®—ã¨è·é›¢ã‚½ãƒ¼ãƒˆ
 */

/** --- Sample dataset (replace with real data) --- */
const EQUIPMENTS = [
  {
    id: "e1",
    name: "Xç·šå›æŠ˜è£…ç½®ï¼ˆXRDï¼‰ï¼ˆX'Pertï¼‰",
    category: "åˆ†æãƒ»è¨ˆæ¸¬",
    subcategory: "Xç·šå›æŠ˜",
    prefecture: "åŒ—æµ·é“",
    city: "æœ­å¹Œå¸‚",
    org: "åŒ—æµ·é“å¤§å­¦",
    status: "ä¸æ˜", // å¯/è¦ç›¸è«‡/ä¸æ˜
    external: true,
    free: false,
    reservable: true,
    support: false,
    priceNote: "æ–™é‡‘è¦ç›¸è«‡",
    updated: "2026-01-25",
    lat: 43.0746, lng: 141.3400,
    links: { detail: "#", eqnet: "#" }
  },
  {
    id: "e2",
    name: "æ°´å¹³å‹å¤šç›®çš„Xç·šå›æŠ˜è£…ç½®ï¼ˆXRDï¼‰",
    category: "åˆ†æãƒ»è¨ˆæ¸¬",
    subcategory: "Xç·šå›æŠ˜",
    prefecture: "åŒ—æµ·é“",
    city: "æœ­å¹Œå¸‚",
    org: "åŒ—æµ·é“å¤§å­¦",
    status: "è¦ç›¸è«‡",
    external: true,
    free: false,
    reservable: true,
    support: true,
    priceNote: "æ–™é‡‘è¦ç›¸è«‡",
    updated: "2026-01-18",
    lat: 43.0746, lng: 141.3400,
    links: { detail: "#", eqnet: "#" }
  },
  {
    id: "e3",
    name: "Xç·šå›æŠ˜è£…ç½®",
    category: "Xç·šé–¢é€£",
    subcategory: "Xç·šå›æŠ˜",
    prefecture: "åŒ—æµ·é“",
    city: "å‡½é¤¨å¸‚",
    org: "å…¬çš„ç ”ç©¶æ©Ÿé–¢A",
    status: "å¯",
    external: true,
    free: false,
    reservable: false,
    support: false,
    priceNote: "æ–™é‡‘è¦ç›¸è«‡",
    updated: "2025-12-28",
    lat: 41.7687, lng: 140.7288,
    links: { detail: "#", eqnet: "#" }
  },
  {
    id: "e4",
    name: "Xç·šå›æŠ˜è£…ç½®ï¼ˆè©¦æ–™å¹ä»˜ä½æ¸©è£…ç½®ä»˜ï¼‰",
    category: "Xç·šé–¢é€£",
    subcategory: "Xç·šå›æŠ˜",
    prefecture: "åŒ—æµ·é“",
    city: "æ—­å·å¸‚",
    org: "å…¬çš„ç ”ç©¶æ©Ÿé–¢B",
    status: "å¯",
    external: true,
    free: true,
    reservable: true,
    support: true,
    priceNote: "ç„¡æ–™",
    updated: "2026-01-03",
    lat: 43.7706, lng: 142.3650,
    links: { detail: "#", eqnet: "#" }
  },
  {
    id: "e5",
    name: "ãƒŠãƒã‚¹ã‚±ãƒ¼ãƒ«Xç·šæ§‹é€ è§£æè£…ç½®",
    category: "Xç·šé–¢é€£",
    subcategory: "æ§‹é€ è§£æ",
    prefecture: "åŒ—æµ·é“",
    city: "å¸¯åºƒå¸‚",
    org: "å…¬çš„ç ”ç©¶æ©Ÿé–¢C",
    status: "å¯",
    external: false,
    free: false,
    reservable: true,
    support: true,
    priceNote: "æ–™é‡‘è¦ç›¸è«‡",
    updated: "2025-11-12",
    lat: 42.9236, lng: 143.1960,
    links: { detail: "#", eqnet: "#" }
  },
  {
    id: "e6",
    name: "ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—Xç·šå›æŠ˜è£…ç½®",
    category: "Xç·šé–¢é€£",
    subcategory: "Xç·šå›æŠ˜",
    prefecture: "åŒ—æµ·é“",
    city: "é‡§è·¯å¸‚",
    org: "å…¬çš„ç ”ç©¶æ©Ÿé–¢D",
    status: "ä¸æ˜",
    external: true,
    free: false,
    reservable: false,
    support: false,
    priceNote: "æ–™é‡‘è¦ç›¸è«‡",
    updated: "2025-10-05",
    lat: 42.9849, lng: 144.3818,
    links: { detail: "#", eqnet: "#" }
  },

  // çœŒåˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒå‹•ãã‚ˆã†ã«å°‘ã—ã ã‘ä»–çœŒã‚‚è¿½åŠ ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
  {
    id: "e7",
    name: "é€éé›»å­é¡•å¾®é¡ï¼ˆTEMï¼‰",
    category: "é¡•å¾®é¡",
    subcategory: "TEM",
    prefecture: "æ±äº¬éƒ½",
    city: "æ–‡äº¬åŒº",
    org: "å¤§å­¦E",
    status: "è¦ç›¸è«‡",
    external: true,
    free: false,
    reservable: true,
    support: true,
    priceNote: "æ–™é‡‘è¦ç›¸è«‡",
    updated: "2026-01-10",
    lat: 35.7175, lng: 139.7620,
    links: { detail: "#", eqnet: "#" }
  },
  {
    id: "e8",
    name: "ICP-MS",
    category: "åˆ†æãƒ»è¨ˆæ¸¬",
    subcategory: "è³ªé‡åˆ†æ",
    prefecture: "èŒ¨åŸçœŒ",
    city: "ã¤ãã°å¸‚",
    org: "ç ”ç©¶æ©Ÿé–¢F",
    status: "å¯",
    external: true,
    free: false,
    reservable: true,
    support: false,
    priceNote: "æ–™é‡‘è¦ç›¸è«‡",
    updated: "2026-01-21",
    lat: 36.0838, lng: 140.0764,
    links: { detail: "#", eqnet: "#" }
  }
];

/** --- State --- */
const state = {
  region: "åŒ—æµ·é“",     // ä¾‹ï¼šåˆæœŸè¡¨ç¤ºã‚’åŒ—æµ·é“ã«
  category: "",
  keyword: "XRD",
  filters: { external:false, free:false, reservable:false, support:false },
  sort: "relevance",
  activeTab: "map",
  geo: { enabled:false, lat:null, lng:null },
  orgFilter: "" // å³ãƒ‘ãƒãƒ«æ©Ÿé–¢åˆ¥ã‹ã‚‰é¸æŠã—ãŸå ´åˆã«ä½¿ã†
};

/** --- Utilities --- */
const fmtDateJP = (iso) => {
  if (!iso) return "";
  const [y,m,d] = iso.split("-");
  return `${y}.${m}.${d}`;
};

const haversineKm = (lat1, lon1, lat2, lon2) => {
  const toRad = (v) => v * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
};

const uniq = (arr) => [...new Set(arr)].sort((a,b)=>a.localeCompare(b,"ja"));

/** --- DOM --- */
const el = (id) => document.getElementById(id);
const regionSel = el("region");
const categorySel = el("category");
const keywordInp = el("keyword");
const sortSel = el("sortSel");
const cards = el("cards");
const chips = el("chips");
const resultsTitle = el("resultsTitle");
const resultsSub = el("resultsSub");
const panelContent = el("panelContent");
const geoBtn = el("geoBtn");

const fExternal = el("fExternal");
const fFree = el("fFree");
const fReservable = el("fReservable");
const fSupport = el("fSupport");

/** --- Init selects --- */
function initSelects(){
  // Regions
  const regions = uniq(EQUIPMENTS.map(x => x.prefecture));
  regions.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    regionSel.appendChild(opt);
  });

  // Categories
  const categories = uniq(EQUIPMENTS.map(x => x.category));
  categories.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    categorySel.appendChild(opt);
  });

  // Set initial
  regionSel.value = state.region || "";
  categorySel.value = state.category || "";
  keywordInp.value = state.keyword || "";
  sortSel.value = state.sort || "relevance";

  fExternal.checked = state.filters.external;
  fFree.checked = state.filters.free;
  fReservable.checked = state.filters.reservable;
  fSupport.checked = state.filters.support;
}

/** --- Filtering / sorting --- */
function getFiltered(){
  const kw = (state.keyword || "").trim().toLowerCase();
  let list = EQUIPMENTS.slice();

  // Region / Category / Org filter
  if (state.region) list = list.filter(x => x.prefecture === state.region);
  if (state.category) list = list.filter(x => x.category === state.category);
  if (state.orgFilter) list = list.filter(x => x.org === state.orgFilter);

  // Keyword: name, category, subcategory
  if (kw){
    list = list.filter(x => {
      const hay = `${x.name} ${x.category} ${x.subcategory} ${x.org} ${x.city}`.toLowerCase();
      return hay.includes(kw);
    });
  }

  // Advanced filters
  const f = state.filters;
  if (f.external) list = list.filter(x => x.external);
  if (f.free) list = list.filter(x => x.free);
  if (f.reservable) list = list.filter(x => x.reservable);
  if (f.support) list = list.filter(x => x.support);

  // Distance calc (only if geo enabled)
  if (state.geo.enabled && state.geo.lat != null && state.geo.lng != null){
    list = list.map(x => {
      const hasCoord = typeof x.lat === "number" && typeof x.lng === "number";
      const dist = hasCoord ? haversineKm(state.geo.lat, state.geo.lng, x.lat, x.lng) : null;
      return { ...x, _distKm: dist };
    });
  } else {
    list = list.map(x => ({...x, _distKm: null}));
  }

  // Sorting
  list.sort((a,b) => {
    switch(state.sort){
      case "distance":
        // nulls last
        if (a._distKm == null && b._distKm == null) return 0;
        if (a._distKm == null) return 1;
        if (b._distKm == null) return -1;
        return a._distKm - b._distKm;

      case "updated":
        return (b.updated || "").localeCompare(a.updated || "");

      case "availability": {
        const rank = (s) => s === "å¯" ? 0 : (s === "è¦ç›¸è«‡" ? 1 : 2);
        return rank(a.status) - rank(b.status);
      }

      case "freeFirst":
        if (a.free !== b.free) return a.free ? -1 : 1;
        return (b.updated || "").localeCompare(a.updated || "");

      case "relevance":
      default:
        // Simple: exact keyword hit earlier + updated desc
        const score = (x) => {
          let s = 0;
          if (kw && x.name.toLowerCase().includes(kw)) s += 3;
          if (kw && (x.category+" "+x.subcategory).toLowerCase().includes(kw)) s += 1;
          if (x.external) s += 0.3;
          if (x.free) s += 0.2;
          return s;
        };
        const d = score(b) - score(a);
        if (Math.abs(d) > 0.001) return d;
        return (b.updated || "").localeCompare(a.updated || "");
    }
  });

  return list;
}

/** --- Render chips --- */
function renderChips(){
  chips.innerHTML = "";

  const addChip = (label, onRemove) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "chip";
    btn.setAttribute("aria-label", `${label} ã‚’è§£é™¤`);
    btn.innerHTML = `<span>${label}</span><span class="x" aria-hidden="true">Ã—</span>`;
    btn.addEventListener("click", onRemove);
    chips.appendChild(btn);
  };

  if (state.region) addChip(state.region, () => { state.region=""; regionSel.value=""; state.orgFilter=""; renderAll(); });
  if (state.category) addChip(state.category, () => { state.category=""; categorySel.value=""; renderAll(); });
  if (state.keyword?.trim()) addChip(`"${state.keyword.trim()}"`, () => { state.keyword=""; keywordInp.value=""; renderAll(); });
  if (state.orgFilter) addChip(`æ©Ÿé–¢ï¼š${state.orgFilter}`, () => { state.orgFilter=""; renderAll(); });

  if (state.filters.external) addChip("å­¦å¤–åˆ©ç”¨å¯", () => { state.filters.external=false; fExternal.checked=false; renderAll(); });
  if (state.filters.free) addChip("ç„¡æ–™", () => { state.filters.free=false; fFree.checked=false; renderAll(); });
  if (state.filters.reservable) addChip("äºˆç´„å¯", () => { state.filters.reservable=false; fReservable.checked=false; renderAll(); });
  if (state.filters.support) addChip("æ¸¬å®šæ”¯æ´ã‚ã‚Š", () => { state.filters.support=false; fSupport.checked=false; renderAll(); });

  if (state.geo.enabled) addChip("ç¾åœ¨åœ°", () => { disableGeo(); renderAll(); });

  if (!chips.childElementCount){
    const span = document.createElement("span");
    span.className = "muted";
    span.style.fontSize = "14px";
    span.textContent = "é©ç”¨ä¸­ã®æ¡ä»¶ï¼šãªã—";
    chips.appendChild(span);
  }
}

/** --- Render cards --- */
function badgeClass(status){
  if (status === "å¯") return "badge badge--ok";
  if (status === "è¦ç›¸è«‡") return "badge badge--warn";
  return "badge badge--unknown";
}
function fmtDist(km){
  if (km == null) return "";
  if (km < 1) return `${Math.round(km*1000)} m`;
  return `${km.toFixed(1)} km`;
}
function renderCards(list){
  cards.innerHTML = "";

  if (!list.length){
    cards.innerHTML = `
      <div class="card">
        <div class="card__head">
          <div class="card__title">è©²å½“ã™ã‚‹æ©Ÿå™¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
          <span class="badge badge--unknown">0ä»¶</span>
        </div>
        <div class="card__sub">æ¡ä»¶ã‚’æ¸›ã‚‰ã™ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰ãˆã‚‹ã€åˆ¥ã®åœ°åŸŸã‚’è©¦ã—ã¦ãã ã•ã„ã€‚</div>
      </div>
    `;
    return;
  }

  list.forEach(x => {
    const flags = [];
    flags.push(`<span class="flag">å­¦å¤–åˆ©ç”¨ï¼š${x.external ? "å¯" : "ä¸å¯/ä¸æ˜"}</span>`);
    flags.push(`<span class="flag">æ–™é‡‘ï¼š${x.free ? "ç„¡æ–™" : (x.priceNote || "è¦ç›¸è«‡")}</span>`);
    flags.push(`<span class="flag">äºˆç´„ï¼š${x.reservable ? "å¯" : "ä¸æ˜/ä¸å¯"}</span>`);
    if (x.support) flags.push(`<span class="flag">æ¸¬å®šæ”¯æ´ã‚ã‚Š</span>`);

    const distLine = (state.geo.enabled && x._distKm != null)
      ? `<div class="muted">è·é›¢ï¼š${fmtDist(x._distKm)}ï¼ˆç¾åœ¨åœ°ï¼‰</div>`
      : (state.geo.enabled ? `<div class="muted">è·é›¢ï¼šåº§æ¨™æœªç™»éŒ²</div>` : ``);

    const card = document.createElement("article");
    card.className = "card";
    card.innerHTML = `
      <div class="card__head">
        <div>
          <div class="card__title">${escapeHtml(x.name)}</div>
          <div class="card__sub">ã‚«ãƒ†ã‚´ãƒªï¼š${escapeHtml(x.category)} / ${escapeHtml(x.subcategory)}</div>
        </div>
        <span class="${badgeClass(x.status)}">${escapeHtml(x.status)}</span>
      </div>

      <div class="card__meta">
        <div>${escapeHtml(x.org)} / ${escapeHtml(x.prefecture)} ${escapeHtml(x.city)}</div>
        <div class="muted">æ›´æ–°ï¼š${fmtDateJP(x.updated)}</div>
        ${distLine}
      </div>

      <div class="flags">${flags.join("")}</div>

      <div class="card__cta">
        <a class="btn btn--primary btn--small" href="${x.links.detail}" aria-label="${escapeHtml(x.name)} ã®æ©Ÿå™¨ãƒšãƒ¼ã‚¸ã¸">æ©Ÿå™¨ãƒšãƒ¼ã‚¸ã¸</a>
        <a class="btn btn--ghost btn--small" href="${x.links.eqnet}" target="_blank" rel="noreferrer" aria-label="${escapeHtml(x.name)} ã‚’eqnetã§åˆ©ç”¨ç™»éŒ²ï¼ˆåˆ¥ã‚¿ãƒ–ï¼‰">eqnetã§åˆ©ç”¨ç™»éŒ² â†—</a>
      </div>
    `;
    cards.appendChild(card);
  });
}

/** --- Right panel rendering --- */
function renderPanel(list){
  panelContent.innerHTML = "";

  if (state.activeTab === "map"){
    // This prototype doesn't integrate a real map API. Provide value anyway:
    const canDistance = state.geo.enabled && list.some(x => x._distKm != null);
    const topNearest = canDistance
      ? list.filter(x => x._distKm != null).slice(0, 5)
      : [];

    const wrapper = document.createElement("div");
    wrapper.innerHTML = `
      <div class="empty">
        <div class="empty__title">åœ°å›³è¡¨ç¤ºã¯æº–å‚™ä¸­ã§ã™</div>
        <div class="empty__text">ä»£ã‚ã‚Šã«ã€è¿‘ã„é †ãƒ»çœŒåˆ¥ãƒ»æ©Ÿé–¢åˆ¥ã§æ¢ç´¢ã§ãã¾ã™ã€‚</div>
      </div>
      <div class="notice">
        ${state.geo.enabled
          ? "ç¾åœ¨åœ°ãŒæœ‰åŠ¹ã§ã™ã€‚è·é›¢ã‚’è¡¨ç¤ºã§ãã‚‹æ©Ÿå™¨ã¯ã€Œè·é›¢ã€ã‚½ãƒ¼ãƒˆãŒä½¿ãˆã¾ã™ã€‚"
          : "ğŸ“ç¾åœ¨åœ°ã‚’ä½¿ã†ã¨ã€è¿‘ã„é †ã§æ¢ã—ã‚„ã™ããªã‚Šã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯ãŒå¿…è¦ã§ã™ï¼‰ã€‚"}
      </div>
    `;

    if (topNearest.length){
      const block = document.createElement("div");
      block.className = "listblock";
      block.innerHTML = `<div class="notice" style="margin-top:0;"><b>è¿‘ã„æ©Ÿå™¨ï¼ˆè·é›¢ãŒåˆ†ã‹ã‚‹ã‚‚ã®ï¼‰</b></div>`;
      topNearest.forEach(x => {
        const row = document.createElement("div");
        row.className = "itemrow";
        row.innerHTML = `
          <div>
            <div style="font-weight:900">${escapeHtml(shorten(x.name, 34))}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(x.org)} / ${escapeHtml(x.city)}</div>
          </div>
          <div class="count">${fmtDist(x._distKm)}</div>
        `;
        block.appendChild(row);
      });
      wrapper.appendChild(block);
    }

    panelContent.appendChild(wrapper);
    return;
  }

  if (state.activeTab === "pref"){
    const counts = countBy(EQUIPMENTS, x => x.prefecture); // å…¨ä½“ã®çœŒåˆ¥ï¼ˆæ¢ç´¢èµ·ç‚¹ã¨ã—ã¦å¼·ã„ï¼‰
    const sorted = Object.entries(counts).sort((a,b)=> b[1]-a[1]).slice(0, 10);

    const title = document.createElement("div");
    title.className = "notice";
    title.style.marginTop = "0";
    title.innerHTML = `<b>æ©Ÿå™¨ãŒå¤šã„éƒ½é“åºœçœŒ</b><div class="muted">ã‚¯ãƒªãƒƒã‚¯ã§åœ°åŸŸã‚’åˆ‡ã‚Šæ›¿ãˆ</div>`;
    panelContent.appendChild(title);

    const block = document.createElement("div");
    block.className = "listblock";
    sorted.forEach(([pref, cnt]) => {
      const row = document.createElement("div");
      row.className = "itemrow";
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = pref;
      btn.addEventListener("click", () => {
        state.region = pref;
        regionSel.value = pref;
        state.orgFilter = "";
        renderAll();
      });
      row.appendChild(btn);

      const right = document.createElement("div");
      right.className = "count";
      right.textContent = `${cnt}ä»¶`;
      row.appendChild(right);

      block.appendChild(row);
    });
    panelContent.appendChild(block);

    const note = document.createElement("div");
    note.className = "notice";
    note.textContent = "æ¤œç´¢ä¸­ã®æ¡ä»¶ã¯å·¦å´ã®ã€Œé©ç”¨ä¸­ãƒãƒƒãƒ—ã€ã§ç¢ºèªãƒ»è§£é™¤ã§ãã¾ã™ã€‚";
    panelContent.appendChild(note);
    return;
  }

  if (state.activeTab === "org"){
    const counts = countBy(list, x => x.org); // ç¾åœ¨ã®çµã‚Šè¾¼ã¿çµæœå†…ã§ã®æ©Ÿé–¢åˆ¥
    const sorted = Object.entries(counts).sort((a,b)=> b[1]-a[1]);

    const title = document.createElement("div");
    title.className = "notice";
    title.style.marginTop = "0";
    title.innerHTML = `<b>æ©Ÿé–¢åˆ¥ï¼ˆç¾åœ¨ã®æ¤œç´¢æ¡ä»¶å†…ï¼‰</b><div class="muted">ã‚¯ãƒªãƒƒã‚¯ã§æ©Ÿé–¢ã‚’å›ºå®šè¡¨ç¤º</div>`;
    panelContent.appendChild(title);

    if (!sorted.length){
      panelContent.appendChild(Object.assign(document.createElement("div"), {
        className: "empty",
        innerHTML: `<div class="empty__title">è¡¨ç¤ºã§ãã‚‹æ©Ÿé–¢ãŒã‚ã‚Šã¾ã›ã‚“</div><div class="empty__text">æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</div>`
      }));
      return;
    }

    const block = document.createElement("div");
    block.className = "listblock";
    sorted.slice(0, 12).forEach(([org, cnt]) => {
      const row = document.createElement("div");
      row.className = "itemrow";
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = org;
      btn.addEventListener("click", () => {
        state.orgFilter = org;
        renderAll();
      });
      row.appendChild(btn);

      const right = document.createElement("div");
      right.className = "count";
      right.textContent = `${cnt}ä»¶`;
      row.appendChild(right);

      block.appendChild(row);
    });
    panelContent.appendChild(block);

    const note = document.createElement("div");
    note.className = "notice";
    note.textContent = "æ©Ÿé–¢ã®å›ºå®šè¡¨ç¤ºã¯ã€ãƒãƒƒãƒ—ï¼ˆæ©Ÿé–¢ï¼šâ€¦ï¼‰ã§è§£é™¤ã§ãã¾ã™ã€‚";
    panelContent.appendChild(note);
    return;
  }
}

/** --- Titles --- */
function renderTitles(list){
  const regionLabel = state.region ? `${state.region}ã®çµæœ` : "å…¨å›½ã®çµæœ";
  const count = list.length;

  resultsTitle.textContent = regionLabel;
  const parts = [];
  parts.push(`${count}ä»¶`);
  if (state.sort === "distance" && state.geo.enabled) parts.push("è¿‘ã„é †");
  if (state.sort === "updated") parts.push("æ›´æ–°æ—¥é †");
  if (state.sort === "freeFirst") parts.push("ç„¡æ–™å„ªå…ˆ");
  if (state.sort === "availability") parts.push("åˆ©ç”¨å¯å¦é †");
  if (state.sort === "relevance") parts.push("ãŠã™ã™ã‚");
  resultsSub.textContent = parts.length ? `ï¼ˆ${parts.join("ãƒ»")}ï¼‰` : "";
}

/** --- Tab handling --- */
function setActiveTab(tab){
  state.activeTab = tab;
  for (const t of document.querySelectorAll(".tab")){
    const is = t.dataset.tab === tab;
    t.classList.toggle("is-active", is);
    t.setAttribute("aria-selected", is ? "true" : "false");
  }
}

/** --- Geolocation --- */
function disableGeo(){
  state.geo.enabled = false;
  state.geo.lat = null;
  state.geo.lng = null;
  geoBtn.setAttribute("aria-pressed", "false");
}

async function enableGeo(){
  if (!navigator.geolocation){
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
    return;
  }
  return new Promise((resolve) => {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        state.geo.enabled = true;
        state.geo.lat = pos.coords.latitude;
        state.geo.lng = pos.coords.longitude;
        geoBtn.setAttribute("aria-pressed", "true");
        // è·é›¢ãŒå–ã‚ŒãŸã‚‰ã‚½ãƒ¼ãƒˆã‚’è·é›¢ã¸å¯„ã›ã‚‹ï¼ˆä½“é¨“å„ªå…ˆï¼‰
        state.sort = "distance";
        sortSel.value = "distance";
        resolve(true);
        renderAll();
      },
      (err) => {
        // Permission denied or other error
        alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰ã€‚");
        resolve(false);
      },
      { enableHighAccuracy: false, timeout: 8000, maximumAge: 300000 }
    );
  });
}

/** --- Events --- */
function bindEvents(){
  el("searchBtn").addEventListener("click", () => {
    syncStateFromInputs();
    renderAll();
  });

  regionSel.addEventListener("change", () => { state.region = regionSel.value; state.orgFilter=""; renderAll(); });
  categorySel.addEventListener("change", () => { state.category = categorySel.value; state.orgFilter=""; renderAll(); });
  keywordInp.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      syncStateFromInputs();
      renderAll();
    }
  });
  keywordInp.addEventListener("change", () => { state.keyword = keywordInp.value; state.orgFilter=""; renderAll(); });

  sortSel.addEventListener("change", () => {
    state.sort = sortSel.value;
    renderAll();
  });

  fExternal.addEventListener("change", () => { state.filters.external = fExternal.checked; renderAll(); });
  fFree.addEventListener("change", () => { state.filters.free = fFree.checked; renderAll(); });
  fReservable.addEventListener("change", () => { state.filters.reservable = fReservable.checked; renderAll(); });
  fSupport.addEventListener("change", () => { state.filters.support = fSupport.checked; renderAll(); });

  el("toggleAdvanced").addEventListener("click", () => {
    const adv = el("advanced");
    const isOpen = !adv.hidden;
    adv.hidden = isOpen;
    el("toggleAdvanced").setAttribute("aria-expanded", String(!isOpen));
    el("toggleAdvanced").textContent = !isOpen ? "è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ â–²" : "è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿ â–¼";
  });

  el("resetBtn").addEventListener("click", () => {
    state.region = "";
    state.category = "";
    state.keyword = "";
    state.orgFilter = "";
    state.filters = { external:false, free:false, reservable:false, support:false };
    state.sort = "relevance";
    regionSel.value = "";
    categorySel.value = "";
    keywordInp.value = "";
    fExternal.checked = false;
    fFree.checked = false;
    fReservable.checked = false;
    fSupport.checked = false;
    sortSel.value = "relevance";
    disableGeo();
    renderAll();
  });

  geoBtn.addEventListener("click", async () => {
    if (state.geo.enabled){
      disableGeo();
      renderAll();
      return;
    }
    await enableGeo();
  });

  // Tabs
  for (const t of document.querySelectorAll(".tab")){
    t.addEventListener("click", () => {
      setActiveTab(t.dataset.tab);
      renderAll();
    });
  }
}

/** --- Helpers --- */
function syncStateFromInputs(){
  state.region = regionSel.value;
  state.category = categorySel.value;
  state.keyword = keywordInp.value;
}

function countBy(list, keyFn){
  return list.reduce((acc, x) => {
    const k = keyFn(x);
    acc[k] = (acc[k] || 0) + 1;
    return acc;
  }, {});
}

function shorten(s, n){
  if (!s) return "";
  return s.length > n ? s.slice(0, n-1) + "â€¦" : s;
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** --- Main render --- */
function renderAll(){
  renderChips();

  const list = getFiltered();

  renderTitles(list);
  renderCards(list);
  renderPanel(list);

  // Disable distance sort if geo is off (still selectable but less useful)
  const distanceOpt = [...sortSel.options].find(o => o.value === "distance");
  if (distanceOpt){
    distanceOpt.textContent = state.geo.enabled ? "è·é›¢ï¼ˆç¾åœ¨åœ°ï¼‰" : "è·é›¢ï¼ˆç¾åœ¨åœ°ï¼šæœªè¨­å®šï¼‰";
  }
}

/** --- Boot --- */
initSelects();
bindEvents();
// åˆæœŸè¡¨ç¤ºï¼šåŒ—æµ·é“ + XRD ã‚’å…¥ã‚ŒãŸçŠ¶æ…‹ã§è¦‹ãˆã‚‹ã‚ˆã†ã«ï¼ˆå¿…è¦ãªã‚‰ state ã‚’å¤‰ãˆã¦ãã ã•ã„ï¼‰
renderAll();
</script>
</body>
</html>
